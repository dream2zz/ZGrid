<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="clr-namespace:ZGrid.Models"
             xmlns:local="clr-namespace:ZGrid.Controls"
             x:Class="ZGrid.Controls.PropertyGrid"
             x:Name="Root">
  <UserControl.Resources>
    <models:NotConverter x:Key="NotConverter"/>
    <models:EditorKindEqualsConverter x:Key="EditorKindEquals"/>
    <models:BoolToGlyphConverter x:Key="BoolToGlyph"/>

    <!-- Property row template -->
    <DataTemplate x:Key="PropertyEntryTemplate" x:DataType="models:PropertyEntry">
      <!-- Two rows: row0 label+input, row1 (optional) full-width cascader panel -->
      <Grid ColumnDefinitions="200,*" RowDefinitions="Auto,Auto" Margin="0,2">
        <!-- label always aligned with the input on the same row -->
        <TextBlock Grid.Column="0" Grid.Row="0" Text="{Binding DisplayName}" VerticalAlignment="Center" Margin="8,0,0,0"/>

        <!-- input cell -->
        <ContentControl Grid.Column="1" Grid.Row="0"
                        Content="{Binding}"
                        HorizontalContentAlignment="Stretch"
                        IsEnabled="{Binding IsReadOnly, Converter={StaticResource NotConverter}}">
          <ContentControl.Styles>
            <Style Selector="ContentControl">
              <Setter Property="ContentTemplate">
                <Setter.Value>
                  <DataTemplate x:DataType="models:PropertyEntry">
                    <!-- Input row switches per editor kind -->
                    <Grid>
                      <!-- Bool editor -->
                      <CheckBox IsVisible="{Binding EditorKind, Converter={StaticResource EditorKindEquals}, ConverterParameter=Bool}"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Center"
                                IsChecked="{Binding BoolValue, Mode=TwoWay}"/>

                      <!-- Enum editor -->
                      <ComboBox IsVisible="{Binding EditorKind, Converter={StaticResource EditorKindEquals}, ConverterParameter=Enum}"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Center"
                                ItemsSource="{Binding EnumValues}"
                                SelectedItem="{Binding EnumValue, Mode=TwoWay}"/>

                      <!-- Text editor -->
                      <TextBox IsVisible="{Binding EditorKind, Converter={StaticResource EditorKindEquals}, ConverterParameter=Text}"
                               HorizontalAlignment="Stretch"
                               VerticalAlignment="Center"
                               MinHeight="28"
                               Text="{Binding StringValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                      <!-- Cascader header (TextBox with overlaid button •••) -->
                      <Grid IsVisible="{Binding EditorKind, Converter={StaticResource EditorKindEquals}, ConverterParameter=Cascader}"
                            VerticalAlignment="Center">
                        <TextBox x:Name="CascaderInput"
                                 IsReadOnly="True"
                                 MinHeight="28"
                                 Watermark="请选择..."
                                 Text="{Binding SelectedLevel3}" Margin="0"/>
                        <Button Classes="square-btn"
                                Command="{Binding ToggleCascaderCommand}"
                                Content="•••"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Stretch"
                                VerticalContentAlignment="Center"
                                Margin="4,0,4,0"/>
                      </Grid>
                    </Grid>
                  </DataTemplate>
                </Setter.Value>
              </Setter>
            </Style>
          </ContentControl.Styles>
        </ContentControl>

        <!-- Full width cascader expanding panel (occupies two columns) -->
        <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                Margin="0,6,0,0" BorderThickness="1" BorderBrush="#DDD" CornerRadius="2"
                Background="#FFF"
                IsVisible="{Binding IsCascaderOpen}">
          <Grid ColumnDefinitions="*,Auto,*,Auto,*" MinHeight="140">
            <!-- Level 1 -->
            <ListBox Grid.Column="0" ItemsSource="{Binding Level1Options}"
                     SelectedItem="{Binding SelectedLevel1, Mode=TwoWay}"
                     BorderThickness="0"/>
            <Border Grid.Column="1" Width="1" Background="#DDD"/>

            <!-- Level 2 -->
            <ListBox Grid.Column="2" ItemsSource="{Binding Level2Options}"
                     SelectedItem="{Binding SelectedLevel2, Mode=TwoWay}"
                     BorderThickness="0"/>
            <Border Grid.Column="3" Width="1" Background="#DDD"/>

            <!-- Level 3 -->
            <ListBox Grid.Column="4" ItemsSource="{Binding Level3Options}"
                     SelectedItem="{Binding SelectedLevel3, Mode=TwoWay}"
                     BorderThickness="0"/>
          </Grid>
        </Border>
      </Grid>
    </DataTemplate>
  </UserControl.Resources>

  <UserControl.Styles>
    <!-- Collapse button style: square outline, no fill in any state -->
    <Style Selector="Button.collapse-btn">
      <Setter Property="Background" Value="Transparent"/>
      <Setter Property="BorderBrush" Value="#8C8C8C"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="0"/>
      <Setter Property="Padding" Value="0"/>
      <Setter Property="HorizontalContentAlignment" Value="Center"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
      <Setter Property="FontWeight" Value="Bold"/>
      <Setter Property="FontSize" Value="12"/>
      <Setter Property="MinWidth" Value="16"/>
      <Setter Property="MinHeight" Value="16"/>
      <Setter Property="Width" Value="16"/>
      <Setter Property="Height" Value="16"/>
    </Style>
    <Style Selector="Button.collapse-btn:pointerover">
      <Setter Property="Background" Value="Transparent"/>
    </Style>
    <Style Selector="Button.collapse-btn:pressed">
      <Setter Property="Background" Value="Transparent"/>
    </Style>
    <Style Selector="Button.collapse-btn:focused">
      <Setter Property="Background" Value="Transparent"/>
    </Style>

    <!-- Flat (borderless) button for cascader toggle -->
    <Style Selector="Button.square-btn">
      <Setter Property="Background" Value="Transparent"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="Padding" Value="0"/>
      <Setter Property="Width" Value="28"/>
      <Setter Property="HorizontalAlignment" Value="Left"/>
      <Setter Property="HorizontalContentAlignment" Value="Center"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
      <Setter Property="Focusable" Value="False"/>
    </Style>
    <Style Selector="Button.square-btn:pointerover">
      <Setter Property="Background" Value="Transparent"/>
    </Style>
    <Style Selector="Button.square-btn:pressed">
      <Setter Property="Background" Value="Transparent"/>
    </Style>
  </UserControl.Styles>

  <DockPanel>
      <Grid RowDefinitions="*,Auto">
        <!-- Grouped only view with collapsible groups -->
        <Border Grid.Row="0" BorderThickness="1,1,1,0" BorderBrush="#ddd">
          <ScrollViewer VerticalScrollBarVisibility="Visible" Padding="0">
            <ItemsControl ItemsSource="{Binding Groups, RelativeSource={RelativeSource AncestorType=local:PropertyGrid}}">
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="models:CategoryGroup">
                  <StackPanel>
                    <Border Background="#f0f0f0" Padding="6" BorderThickness="0,1,0,0" BorderBrush="#ddd" HorizontalAlignment="Stretch">
                      <Grid ColumnDefinitions="Auto,*" VerticalAlignment="Center">
                        <Button Grid.Column="0"
                                Classes="collapse-btn"
                                Focusable="False"
                                Command="{Binding ToggleGroupCommand, RelativeSource={RelativeSource AncestorType=local:PropertyGrid}}"
                                CommandParameter="{Binding}" Margin="6">
                          <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="{Binding IsExpanded, Converter={StaticResource BoolToGlyph}}"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                       TextAlignment="Center"/>
                          </Grid>
                        </Button>
                        <TextBlock Grid.Column="1" FontWeight="Bold" Text="{Binding Name}" VerticalAlignment="Center"/>
                      </Grid>
                    </Border>

                    <!-- Restore hover and selection effects using ListBox -->
                    <ListBox ItemsSource="{Binding Items}"
                             ItemTemplate="{StaticResource PropertyEntryTemplate}"
                             BorderThickness="0"
                             Background="Transparent"
                             IsVisible="{Binding IsExpanded}"
                             SelectedItem="{Binding SelectedEntry, Mode=TwoWay, RelativeSource={RelativeSource AncestorType=local:PropertyGrid}}"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             ScrollViewer.VerticalScrollBarVisibility="Disabled"
                             Margin="0,0,20,0">
                      <ListBox.Styles>
                        <Style Selector="ListBoxItem">
                          <Setter Property="Padding" Value="0"/>
                          <Setter Property="MinHeight" Value="28"/>
                        </Style>
                        <!-- Hover background -->
                        <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                          <Setter Property="Background" Value="#E6F2FF"/>
                        </Style>
                        <!-- Selected background -->
                        <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                          <Setter Property="Background" Value="#CDE5FF"/>
                        </Style>
                      </ListBox.Styles>
                    </ListBox>
                  </StackPanel>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>
        </Border>

        <!-- Description panel -->
        <Border Grid.Row="1" Background="#f7f7f7" BorderThickness="1" BorderBrush="#ddd" Padding="8">
          <ContentControl Content="{Binding SelectedEntry, RelativeSource={RelativeSource AncestorType=local:PropertyGrid}}">
            <ContentControl.ContentTemplate>
              <DataTemplate x:DataType="models:PropertyEntry">
                <TextBlock TextWrapping="Wrap" MaxLines="4" Text="{Binding Description}"/>
              </DataTemplate>
            </ContentControl.ContentTemplate>
          </ContentControl>
        </Border>
      </Grid>
    </DockPanel>
</UserControl>